name: Build GStreamer Android

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build GStreamer Android (${{ matrix.abi }})
    runs-on: ubuntu-latest
    container:
      image: nixos/nix:latest
      options: --privileged

    strategy:
      matrix:
        abi: [arm64-v8a]

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: Configure Nix
        run: |
          echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
          echo "accept-flake-config = true" >> /etc/nix/nix.conf

      - name: ðŸ”¨ Build GStreamer Android
        run: |
          echo "Building GStreamer Android for ${{ matrix.abi }}..."
          nix build .#gstreamer-android --print-build-logs

          # Show build results
          echo "::group::Build artifacts"
          ls -lh result/artifacts/
          file result/artifacts/*.so
          echo "::endgroup::"

      - name: ðŸ“Š Verify build
        run: |
          echo "::group::File checksums"
          cat result/artifacts/checksums.txt || sha256sum result/artifacts/*.so
          echo "::endgroup::"

          echo "::group::Architecture verification"
          for so in result/artifacts/*.so; do
            if file "$so" | grep -q "ARM aarch64"; then
              echo "âœ“ $(basename "$so") - ARM aarch64 âœ“"
            else
              echo "âœ— $(basename "$so") - Wrong architecture!"
              exit 1
            fi
          done
          echo "::endgroup::"

      - name: ðŸ“¦ Package artifacts
        run: |
          mkdir -p artifacts/${{ matrix.abi }}
          cp -v result/artifacts/*.so artifacts/${{ matrix.abi }}/
          cp -v result/artifacts/README.md artifacts/ || true
          cp -v result/artifacts/checksums.txt artifacts/${{ matrix.abi }}/ || true

          # Create archive
          tar -czf gstreamer-android-${{ matrix.abi }}.tar.gz -C artifacts .

          # Create artifact info
          cat > artifacts/build-info.txt << EOF
          GStreamer Android Build
          =======================
          Version: 1.26.6
          ABI: ${{ matrix.abi }}
          NDK: r25c
          Platform: android-21
          Commit: ${{ github.sha }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}
          EOF

          cat artifacts/build-info.txt

      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gstreamer-android-${{ matrix.abi }}
          path: |
            artifacts/${{ matrix.abi }}/*.so
            artifacts/*.md
            artifacts/*.txt
          retention-days: 30

      - name: ðŸ“¤ Upload archive
        uses: actions/upload-artifact@v4
        with:
          name: gstreamer-android-${{ matrix.abi }}-archive
          path: gstreamer-android-${{ matrix.abi }}.tar.gz
          retention-days: 90

  # Run development shell to verify environment
  test-devshell:
    name: Test Development Shell
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Install Nix
        uses: cachix/install-nix-action@v26
        with:
          nix_path: nixpkgs=channel:nixos-24.05
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: ðŸ§ª Test development shell
        run: |
          nix develop --command bash -c '
            echo "Testing development shell..."
            echo "GStreamer version: $GSTREAMER_ANDROID_VERSION"
            echo "NDK version: $GSTREAMER_ANDROID_NDK"
            echo "Target ABI: $GSTREAMER_ANDROID_ABI"

            # Test commands exist
            command -v gst-android-info
            gst-android-info
          '

  # Create release on tag
  release:
    name: Create Release
    needs: [build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: ðŸ“¦ Prepare release assets
        run: |
          mkdir -p release

          # Copy archives
          find release-artifacts -name "*.tar.gz" -exec cp {} release/ \;

          # Create combined archive
          cd release-artifacts
          tar -czf ../release/gstreamer-android-all-abis.tar.gz */
          cd ..

          # List release files
          ls -lh release/

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*.tar.gz
          body: |
            ## GStreamer Android Build

            Pre-built GStreamer Android libraries for integration with Android apps.

            ### What's Included
            - `libgstreamer_android.so` - GStreamer JNI wrapper
            - `libc++_shared.so` - C++ standard library

            ### Supported ABIs
            - arm64-v8a (Android 64-bit ARM)

            ### Installation
            1. Download the archive for your target ABI
            2. Extract to `app/src/main/jniLibs/<ABI>/`
            3. Follow the README.md for integration steps

            ### Build Info
            - **GStreamer Version**: 1.26.6
            - **NDK Version**: r25c (25.2.9519653)
            - **Min Android Version**: API 21 (Android 5.0)
            - **Built with**: Nix Flakes

            ### Checksums
            See individual `checksums.txt` files in each archive.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
